# RAG 아키텍처 개요: 카테고리별 유사도 검색 구조

## 📌 핵심 질문에 대한 답변

**Q: "파인다이닝/스시 오마카세 Agent 한정으로 여러 매장들이 Vector DB에서 유사도 검색 기반으로 Context를 가져오는 구조인가?"**

**A: 네, 정확히 맞습니다! ✅**

각 카테고리 Agent는 **자신의 카테고리 컬렉션에서만** 유사도 검색을 수행하여 가장 관련성 높은 과거 사례를 Context로 가져옵니다.

---

## 1. 전체 RAG 워크플로우

### 파인다이닝 Agent 작업 예시

```
📍 새로운 매장: "에빗" (모던 일식, 오마카세)
   └─ collected_info: "에빗은 일본에서 미쉐린 2스타를 보유한 셰프가..."

          ↓

🔍 벡터 DB 검색 (fine_dining_examples 컬렉션)
   └─ 쿼리: collected_info를 768차원 벡터로 변환
   └─ 검색 대상: 과거에 저장된 파인다이닝 매장들

      [저장된 매장들과 유사도]
      - 스시조 (정통 스시, 오마카세)    → 유사도 0.87 ⭐ 1위
      - 모수 (모던 한식, 화덕)          → 유사도 0.72 ⭐ 2위
      - 밍글스 (모던 한식, 발효)        → 유사도 0.65
      - 권숙수 (전통 한식)              → 유사도 0.48
      - 숙수 (모던 한식)                → 유사도 0.44

          ↓

✅ Top-2 선택: 스시조(0.87), 모수(0.72)

          ↓

📝 RAG Context 생성

   [과거 성공 사례 참고]

   **참고 사례 1: 스시조**
   제목: 에도마에 전통 기법과 계절 식재료의 조화를 구현하는 정통 스시야
   요약문:
     1. 일본 도쿄에서 20년 경력의 스시 장인이 운영하며...
     2. 시그니처인 주토로 니기리는 입안에서 녹는 듯한...
     3. 8석 규모의 미니멀한 히노키 목재 카운터는...

   **참고 사례 2: 모수**
   제목: 화덕 구이와 발효 기법의 조화로 한식의 미래를 제시하는 모던 다이닝
   요약문:
     1. 안성재 셰프가 이끄는 모수는 화덕 구이와...
     2. 시그니처 메뉴인 화덕 구이 생선은...
     3. 미니멀한 공간 설계와 자연 채광이...

          ↓

🤖 LLM 호출
   - System Prompt: 파인다이닝 작성 원칙
   - User Prompt: 에빗 매장 정보
   - RAG Context: 스시조, 모수 참고 사례

   → LLM이 스시조, 모수의 스타일을 참고하여 에빗 요약문 생성

          ↓

✅ 검증 통과 → 에빗 요약문 완성

          ↓

💾 fine_dining_examples 컬렉션에 "에빗" 저장
   - 다음 파인다이닝 매장 작업 시 "에빗"도 참고 대상에 포함됨!
```

---

## 2. 카테고리별 독립 컬렉션 구조

### Chroma 벡터 DB 구조

```
./chroma_db/
│
├── 📁 fine_dining_examples (파인다이닝/스시 오마카세)
│   ├── 모수
│   ├── 밍글스
│   ├── 권숙수
│   ├── 에빗
│   ├── 숙수
│   ├── 스시조
│   ├── 스시소라
│   ├── 스시도코로 쿠우
│   ├── 스시사이토
│   └── 이루히 니와
│
│   👆 파인다이닝 Agent는 이 컬렉션에서만 검색!
│
├── 📁 mid_price_examples (중저가 예약 매장)
│   ├── 레스토랑 우오보
│   ├── 퍼멘츠
│   ├── 스시소라 정자점
│   ├── 미트컬쳐
│   ├── 그리노 성수
│   ├── 밴건디스테이크하우스
│   ├── 몽중헌 청담점
│   ├── 더기와 합정점
│   ├── DOTZ
│   └── 야키토리 해공
│
│   👆 중저가 Agent는 이 컬렉션에서만 검색!
│
└── 📁 waiting_hotplace_examples (웨이팅 핫플레이스)
    ├── 달맞이 광장 바베큐
    ├── 이재모피자
    ├── 자매국수
    ├── 하이디라오
    ├── 산청숯불가든
    ├── 숙성도
    ├── 톤쇼우
    ├── 연돈
    ├── 카와카츠
    └── 고기리막국수

    👆 웨이팅 핫플 Agent는 이 컬렉션에서만 검색!
```

### 왜 컬렉션을 분리하나?

| 시나리오 | 통합 컬렉션 (❌) | 분리 컬렉션 (✅) |
|---------|----------------|----------------|
| **파인다이닝 매장 작업** | 중저가, 웨이팅 핫플 매장도 검색됨 → 캐주얼한 톤 섞임 | 파인다이닝만 검색 → 전문적 톤 유지 |
| **중저가 매장 작업** | 파인다이닝의 격식 있는 표현 섞임 | 중저가의 친근한 톤 유지 |
| **웨이팅 핫플 작업** | 파인다이닝/중저가 톤 섞임 | 트렌디한 감성 유지 |

**결론**: 카테고리별로 톤앤매너가 완전히 다르므로, 컬렉션을 분리하여 **검색 품질**과 **스타일 일관성**을 보장합니다.

---

## 3. 유사도 검색 메커니즘

### 3.1 벡터 임베딩

```python
# 1. 텍스트를 768차원 벡터로 변환
collected_info = """
에빗은 일본에서 미쉐린 2스타를 보유한 셰프가 운영하는 오마카세 전문점입니다.
계절 식재료를 활용한 정통 에도마에 스시 기법을 선보이며...
"""

embedding = generate_embedding(collected_info)
# 결과: [0.123, -0.456, 0.789, ..., 0.234]  (768개 float)
```

### 3.2 코사인 유사도 계산

Chroma가 자동으로 수행:

```python
# Chroma의 query() 메서드가 알아서 처리
results = collection.query(
    query_embeddings=[embedding],
    n_results=2,  # Top-2
    include=["documents", "metadatas", "distances"]
)

# Chroma가 자동으로:
# 1. 저장된 모든 문서와 코사인 유사도 계산
# 2. 유사도 높은 순으로 정렬
# 3. Top-2 추출
# 4. 거리(distance) 반환
```

### 3.3 거리 → 유사도 변환

```python
# Chroma는 "거리"를 반환 (작을수록 유사)
# 코사인 거리 범위: 0 (동일) ~ 2 (정반대)

distance = 0.26  # Chroma에서 반환된 거리

# 유사도로 변환 (0~1 범위, 클수록 유사)
similarity = 1.0 - (distance / 2.0)
# 결과: 0.87 (87% 유사)
```

### 3.4 유사도 점수 해석

| 유사도 범위 | 의미 | 액션 |
|-----------|------|------|
| **0.9 ~ 1.0** | 거의 동일 | 예시 복사 의심, 주의 필요 |
| **0.7 ~ 0.9** | 매우 유사 ⭐ | 훌륭한 참고 자료 |
| **0.5 ~ 0.7** | 관련성 있음 | 참고 가능 |
| **0.3 ~ 0.5** | 약한 관련성 | 참고하되 주의 |
| **< 0.3** | 관련성 낮음 | 무시 권장 |

---

## 4. 학습 효과 (Self-Improving)

### 시간에 따른 성능 향상

```
[1일차] fine_dining_examples: 0개
─────────────────────────────────────
첫 번째 매장: "모수"
└─ 검색 결과: 없음
└─ Few-shot 예시만 참고
└─ 성공 시 저장 → fine_dining_examples: 1개

[3일차] fine_dining_examples: 5개
─────────────────────────────────────
여섯 번째 매장: "에빗"
└─ 검색 결과: 5개
└─ Top-2 선택: 스시조, 모수
└─ 더 정확한 참고 자료!
└─ 성공 시 저장 → fine_dining_examples: 6개

[1개월] fine_dining_examples: 80개
─────────────────────────────────────
81번째 매장: "스시 신"
└─ 검색 결과: 80개
└─ Top-2 선택: 가장 유사한 2개
└─ 매우 정확한 참고 자료!
└─ 성공률: 70% → 85%
```

### 검증 성공률 추이

```
저장된 예시 개수에 따른 성공률:

100%│                                    ┌─ 목표: 90%
 90%│                          ┌────────┤
 85%│                    ┌─────┘        │
 80%│              ┌────┘                │
 75%│         ┌────┘                     │
 70%│─────────┘                          │ RAG 효과
 65%│                                    │
    └────────────────────────────────────
     0개    20개    50개    100개   200개
           저장된 예시 개수

핵심: 데이터가 쌓일수록 성능이 급격히 향상!
```

---

## 5. 코드 레벨 설명

### retrieve_similar_examples() 함수

```python
def retrieve_similar_examples(query_text, collection, top_k=2):
    """
    벡터 DB에서 유사한 예시 검색

    Args:
        query_text: 새로운 매장 정보 (텍스트)
        collection: Chroma 컬렉션 (예: fine_dining_examples)
        top_k: 가져올 예시 개수 (기본 2개)

    Returns:
        유사한 예시 리스트 (유사도 포함)
    """

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 1단계: 텍스트 → 벡터 변환
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    query_embedding = generate_embedding(query_text)
    # Vertex AI Text Embedding 사용
    # 입력: "에빗은 일본에서 미쉐린 2스타..."
    # 출력: [0.123, -0.456, ..., 0.234] (768차원)


    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 2단계: Chroma 유사도 검색 (핵심!)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    results = collection.query(
        query_embeddings=[query_embedding],  # 쿼리 벡터
        n_results=top_k,                     # Top-2
        include=["documents", "metadatas", "distances"]
    )

    # Chroma가 자동으로:
    # - fine_dining_examples의 모든 문서와 코사인 유사도 계산
    # - HNSW 인덱스로 빠른 검색 (O(log n))
    # - 유사도 높은 순 정렬
    # - Top-2 추출 및 반환


    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 3단계: 결과 포맷 변환
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    formatted_results = []

    for i in range(len(results['ids'][0])):
        distance = results['distances'][0][i]

        # 거리 → 유사도 변환
        similarity = 1.0 - (distance / 2.0)

        # 메타데이터 파싱
        formatted_results.append({
            "shop_name": "스시조",
            "title": "에도마에 전통 기법과...",
            "summaries": ["문장1", "문장2", "문장3"],
            "score": 0.87  # 유사도 점수
        })

    return formatted_results
    # [
    #   {"shop_name": "스시조", "score": 0.87, ...},
    #   {"shop_name": "모수", "score": 0.72, ...}
    # ]
```

### 검색 → Context 생성 → LLM 호출

```python
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 1: 유사한 과거 사례 검색
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
similar_examples = retrieve_similar_examples(
    query_text=collected_info,           # "에빗은 일본에서..."
    collection=fine_dining_collection,   # 파인다이닝 컬렉션만!
    top_k=2
)
# 결과:
# [
#   {"shop_name": "스시조", "score": 0.87, ...},
#   {"shop_name": "모수", "score": 0.72, ...}
# ]


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 2: RAG Context 생성
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rag_context = format_rag_context(similar_examples)
# 결과:
# """
# [과거 성공 사례 참고]
#
# **참고 사례 1: 스시조**
# 제목: ...
# 요약문: ...
#
# **참고 사례 2: 모수**
# 제목: ...
# 요약문: ...
# """


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 3: LLM 호출 (프롬프트 + RAG Context)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
user_prompt = f"""
{rag_context}  # ← 스시조, 모수 참고 사례

[매장 정보]
매장명: 에빗
정보: {collected_info}

위 과거 사례들의 스타일을 참고하여 에빗 요약문을 작성하세요.
"""

response = client.models.generate_content(
    model="gemini-2.5-pro",
    contents=f"{system_prompt}\n\n{user_prompt}",
    config=generation_config
)

# LLM이 스시조, 모수의 스타일을 학습하여 에빗 요약문 생성!
```

---

## 6. 실제 동작 예시

### 시나리오: 10번째 파인다이닝 매장 작업

```python
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 현재 상태
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
fine_dining_collection.count()  # 9개 저장됨

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 새 매장 정보
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SHOP_NAME = "스시 신"
collected_info = """
교토에서 30년 경력의 장인이 운영하는 정통 스시야.
계절 식재료를 중시하며 에도마에 기법을 고수.
8석 규모의 히노키 카운터...
"""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 유사도 검색
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
print("🔍 유사한 과거 사례 검색 중...\n")
similar_examples = retrieve_similar_examples(
    query_text=collected_info,
    collection=fine_dining_collection,
    top_k=2
)

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 출력 결과
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
"""
✅ 2개 유사 사례 발견

   1. 스시조 (유사도: 0.91)
      - 키워드 매칭: 정통 스시야, 에도마에, 계절 식재료, 히노키

   2. 스시소라 (유사도: 0.84)
      - 키워드 매칭: 장인, 정통 기법, 계절 식재료

⚠️ 다른 후보들:
   - 모수 (유사도: 0.52) → 한식이라 낮음
   - 밍글스 (유사도: 0.48) → 한식이라 낮음
   - 권숙수 (유사도: 0.35) → 전통 한식이라 매우 낮음
"""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# RAG Context 생성
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rag_context = format_rag_context(similar_examples)

"""
[과거 성공 사례 참고]

**참고 사례 1: 스시조**
제목: 에도마에 전통 기법과 계절 식재료의 조화를 구현하는 정통 스시야
유사도 점수: 0.910

**참고 사례 2: 스시소라**
제목: 장인 정신이 깃든 정통 스시 코스로 오마카세의 정수를 제공하는 스시야
유사도 점수: 0.840
"""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# LLM이 위 2개 사례를 참고하여 생성!
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 7. FAQ

### Q1: 왜 Top-2만 가져오나요? 더 많이 가져오면 안 되나요?

**A**: 실험 결과, Top-2가 최적입니다.

- **Top-1**: 다양성 부족, 너무 한쪽으로 치우침
- **Top-2**: ⭐ 적절한 다양성과 관련성 균형
- **Top-3~5**: 관련성 낮은 예시가 섞여 오히려 품질 저하
- **Top-10+**: 프롬프트 길이 증가, 비용 증가, 성능 향상 미미

### Q2: 유사도 0.5 미만도 사용하나요?

**A**: 기본적으로 사용하지만, 필터링 옵션을 추가할 수 있습니다.

```python
# 최소 유사도 필터링
def retrieve_similar_examples(query_text, collection, top_k=2, min_score=0.5):
    # ... 검색 후 ...

    # 유사도 0.5 미만 제거
    filtered = [r for r in results if r['score'] >= min_score]

    return filtered
```

### Q3: 카테고리를 잘못 선택하면 어떻게 되나요?

**A**: 검색 품질이 떨어집니다.

```python
# ❌ 잘못된 예시: 파인다이닝 매장을 중저가 컬렉션에 검색
similar_examples = retrieve_similar_examples(
    query_text="미쉐린 3스타 프렌치...",
    collection=mid_price_collection,  # 중저가 컬렉션!
    top_k=2
)

# 결과: 전혀 관련 없는 매장 반환
# - 퍼멘츠 (비건) - 유사도 0.21
# - 그리노 성수 (브런치) - 유사도 0.18
# → 너무 낮은 유사도, 참고 가치 없음
```

### Q4: 벡터 DB가 비어있으면?

**A**: Few-shot 예시만 사용합니다.

```python
if collection.count() == 0:
    print("⚠️ 유사 사례 없음 (초기 데이터 없음)")
    return []  # 빈 리스트

# 프롬프트에서 Few-shot 예시만 사용
# (기본 버전과 동일)
```

---

## 8. 핵심 요약

### ✅ 현재 RAG 구조

```
각 카테고리 Agent는:

1️⃣ 자신의 카테고리 컬렉션에서만 검색
   - 파인다이닝 → fine_dining_examples
   - 중저가 → mid_price_examples
   - 웨이팅 핫플 → waiting_hotplace_examples

2️⃣ 유사도 검색 (Chroma 자동 수행)
   - 코사인 유사도 기반
   - HNSW 인덱스로 빠른 검색

3️⃣ Top-2 선택
   - 가장 관련성 높은 2개 매장

4️⃣ RAG Context 생성
   - 선택된 2개 매장의 요약문을 프롬프트에 추가

5️⃣ LLM 호출
   - 과거 사례 스타일을 참고하여 생성

6️⃣ 벡터 DB 저장
   - 검증 통과 시 컬렉션에 추가
   - 다음 매장 작업 시 참고 대상에 포함
```

### 🎯 이점

- ✅ **카테고리 격리**: 톤앤매너 오염 방지
- ✅ **유사도 기반**: 가장 관련성 높은 예시 선택
- ✅ **자동 학습**: 데이터 쌓일수록 성능 향상
- ✅ **일관성**: 같은 카테고리 내 스타일 통일
- ✅ **확장성**: 새 카테고리 추가 용이

---

**작성일**: 2025-01-10
**버전**: 1.0
**작성자**: AI Assistant (Claude Code)
